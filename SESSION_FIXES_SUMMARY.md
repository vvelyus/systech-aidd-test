# üéØ –ò—Ç–æ–≥–æ–≤–æ–µ —Ä–µ–∑—é–º–µ —Å–µ—Å—Å–∏–∏: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

## –í–≤–µ–¥–µ–Ω–∏–µ
–≠—Ç–∞ —Å–µ—Å—Å–∏—è –±—ã–ª–∞ –ø–æ—Å–≤—è—â–µ–Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é –æ—à–∏–±–æ–∫ –≤ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ –∏ —Ç–µ–ª–µ–≥—Ä–∞–º –±–æ—Ç–µ, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –≤—ã–∑–≤–∞–Ω—ã –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º–∏ —Ç–∞–π–º–∞—É—Ç–∞–º–∏ –¥–ª—è LLM –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π rate limit –æ—à–∏–±–æ–∫.

---

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ #1: Admin Mode - Timeout Issues ‚è±Ô∏è

### –ü—Ä–æ–±–ª–µ–º–∞
- Admin —Ä–µ–∂–∏–º (Text-to-SQL) –Ω–µ —Ä–∞–±–æ—Ç–∞–ª
- –û—à–∏–±–∫–∞: "Request timed out (too complex query)"
- –¢–∞–π–º–∞—É—Ç—ã –±—ã–ª–∏ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–µ –¥–ª—è LLM –æ–±—Ä–∞–±–æ—Ç–∫–∏

### –ü—Ä–∏—á–∏–Ω–∞
- `request_timeout`: 30 —Å–µ–∫ (–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è Text-to-SQL)
- `text2sql_timeout`: 5 —Å–µ–∫ (—Å–ª–∏—à–∫–æ–º –º–∞–ª–æ)
- SQL execution: 5 —Å–µ–∫ (–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ)

### –†–µ—à–µ–Ω–∏–µ

**–§–∞–π–ª: `src/api/main.py`**
```python
chat_service = ChatService(
    llm_client=_llm_client,
    db_manager=_db_manager,
    logger=_logger,
    request_timeout=60.0,    # ‚Üë –ë—ã–ª–æ: 30s
    text2sql_timeout=15.0,   # ‚Üë –ë—ã–ª–æ: 5s
)
```

**–§–∞–π–ª: `src/api/chat_service.py`**
```python
results = await asyncio.wait_for(
    self.text2sql.execute_and_format(
        text2sql_response.sql,
        max_rows=1000,
        timeout=10.0   # ‚Üë –ë—ã–ª–æ: 5s
    ),
    timeout=20.0   # ‚Üë –ë—ã–ª–æ: 10s
)
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç ‚úÖ
- Simple queries —Ä–∞–±–æ—Ç–∞—é—Ç
- Complex JOINs —Ä–∞–±–æ—Ç–∞—é—Ç
- Aggregations —Ä–∞–±–æ—Ç–∞—é—Ç
- SQL debugging –∞–∫—Ç–∏–≤–µ–Ω

---

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ #2: Rate Limit (429) Errors üîÑ

### –ü—Ä–æ–±–ª–µ–º–∞
- OpenRouter free-tier rate limiting
- –û—à–∏–±–∫–∞: "Error code: 429 - Rate limit exceeded"
- –ó–∞–ø—Ä–æ—Å—ã –ø–∞–¥–∞–ª–∏ –±–µ–∑ retry

### –ü—Ä–∏—á–∏–Ω–∞
- –ù–µ –±—ã–ª–æ –º–µ—Ö–∞–Ω–∏–∑–º–∞ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–∞ –ø—Ä–∏ rate limit
- OpenRouter —Ç—Ä–µ–±—É–µ—Ç backoff –ø–µ—Ä–µ–¥ retry

### –†–µ—à–µ–Ω–∏–µ

**–§–∞–π–ª: `src/llm_client.py`**
–î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `_api_call_with_retry()` —Å:
```python
self.max_retries = 5          # –î–æ 5 –ø–æ–ø—ã—Ç–æ–∫
self.base_delay = 1.0         # –ù–∞—á–∞–ª–æ: 1 —Å–µ–∫

# Exponential backoff: 1s ‚Üí 2s ‚Üí 4s ‚Üí 8s ‚Üí 16s
delay = self.base_delay * (2 ** attempt)
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç ‚úÖ
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry –ø—Ä–∏ 429 –æ—à–∏–±–∫–µ
- –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏
- –ú–∞–∫—Å–∏–º—É–º 5 –ø–æ–ø—ã—Ç–æ–∫ –ø–µ—Ä–µ–¥ –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω—ã–º –æ—Ç–∫–∞–∑–æ–º

---

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ #3: –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ 429 –≤ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ üåê

### –ü—Ä–æ–±–ª–µ–º–∞
- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –±—ã–ª–æ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º
- –°–æ–¥–µ—Ä–∂–∞–ª–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏
- –û–±—Ä–µ–∑–∞–Ω–æ –∏ –≤—ã–≥–ª—è–¥–µ–ª–æ –Ω–µ–∞–∫–∫—É—Ä–∞—Ç–Ω–æ

### –†–µ—à–µ–Ω–∏–µ

**–§–∞–π–ª: `src/api/chat_service.py`**
–û–±–Ω–æ–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º –±–µ–∑ —ç–º–æ–¥–∑–∏:

**–ë—ã–ª–æ:**
```
API Rate Limit Exceeded

The free tier usage limit has been exceeded...
Error code: 429 - {'error': {'message': 'Rate limit e...
```

**–°—Ç–∞–ª–æ:**
```
–õ–∏–º–∏—Ç –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –ø–ª–∞–Ω–∞ –∏—Å—á–µ—Ä–ø–∞–Ω

–î–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç –Ω–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç.

–ß—Ç–æ –¥–µ–ª–∞—Ç—å:
1. –î–æ–±–∞–≤—å—Ç–µ –∫—Ä–µ–¥–∏—Ç—ã –Ω–∞ https://openrouter.ai/account/billing
2. –î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤—Ç—Ä–∞ (00:00 UTC) - –ª–∏–º–∏—Ç —Å–±—Ä–æ—Å–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–æ–ª–µ–µ –ø—Ä–æ—Å—Ç—ã–µ –∑–∞–ø—Ä–æ—Å—ã

–ü–æ—á–µ–º—É —Ç–∞–∫ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:
–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø–ª–∞–Ω –æ–≥—Ä–∞–Ω–∏—á–µ–Ω –ø—Ä–∏–º–µ—Ä–Ω–æ 30-50 –∑–∞–ø—Ä–æ—Å–∞–º–∏ –≤ –¥–µ–Ω—å.
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç ‚úÖ
- –ü–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ß–µ—Ç–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —á—Ç–æ –¥–µ–ª–∞—Ç—å
- –ù–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
- –ë–µ–∑ —ç–º–æ–¥–∑–∏

---

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ #4: –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ 429 –≤ Telegram ü§ñ

### –ü—Ä–æ–±–ª–µ–º–∞
- Telegram –±–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–ª —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
- "–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞..."
- –ù–µ –ø–æ–º–æ–≥–∞–ª–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

### –†–µ—à–µ–Ω–∏–µ

**–§–∞–π–ª: `src/messages.py`**
–î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `rate_limit_error()`:
```python
@staticmethod
def rate_limit_error() -> str:
    return (
        "–õ–∏–º–∏—Ç –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –ø–ª–∞–Ω–∞ –∏—Å—á–µ—Ä–ø–∞–Ω\n\n"
        "–î–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç –Ω–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç.\n\n"
        "–ß—Ç–æ –¥–µ–ª–∞—Ç—å:\n"
        "1. –î–æ–±–∞–≤—å—Ç–µ –∫—Ä–µ–¥–∏—Ç—ã –Ω–∞ https://openrouter.ai/account/billing\n"
        "2. –î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤—Ç—Ä–∞ (00:00 UTC) - –ª–∏–º–∏—Ç —Å–±—Ä–æ—Å–∏—Ç—Å—è\n"
        "3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–æ–ª–µ–µ –ø—Ä–æ—Å—Ç—ã–µ –∑–∞–ø—Ä–æ—Å—ã\n\n"
        "–ü–æ—á–µ–º—É —Ç–∞–∫ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:\n"
        "–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø–ª–∞–Ω –æ–≥—Ä–∞–Ω–∏—á–µ–Ω –ø—Ä–∏–º–µ—Ä–Ω–æ 30-50 –∑–∞–ø—Ä–æ—Å–∞–º–∏ –≤ –¥–µ–Ω—å."
    )
```

**–§–∞–π–ª: `src/bot.py`**
–î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫:
```python
from src.llm_client import RateLimitExceededError

except RateLimitExceededError as e:
    self.logger.warning(f"Rate limit exceeded for user_id={user_id}: {e}")
    await message.answer(BotMessages.rate_limit_error())
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç ‚úÖ
- –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è rate limit –æ—à–∏–±–æ–∫
- –ß–µ—Ç–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ù–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ –±–µ–∑ —ç–º–æ–¥–∑–∏

---

## –§–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã üìä

### –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
- ‚úÖ Admin Mode (Text-to-SQL): –†–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ Normal Chat: –†–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ Statistics: –†–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ Error messages: –î—Ä—É–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ, –Ω–∞ —Ä—É—Å—Å–∫–æ–º

### Telegram Bot
- ‚úÖ Chat: –†–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ Context preservation: –†–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ Error handling: –†–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ Rate limit messages: –î—Ä—É–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ, –Ω–∞ —Ä—É—Å—Å–∫–æ–º

### API Backend
- ‚úÖ Timeout configuration: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞
- ‚úÖ Rate limit handling: –° retry + exponential backoff
- ‚úÖ Error formatting: –î—Ä—É–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- ‚úÖ Logging: –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### Infrastructure
- ‚úÖ Database: SQLite –∞–∫—Ç–∏–≤–Ω–∞
- ‚úÖ Frontend: http://localhost:3000
- ‚úÖ API: http://localhost:8000
- ‚úÖ Bot: –†–∞–±–æ—Ç–∞–µ—Ç

---

## –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–°–æ–∑–¥–∞–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã:
- `ADMIN_MODE_FIXED.md` - –ü–æ–¥—Ä–æ–±–Ω–æ –æ timeout –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏
- `RATE_LIMIT_FIX_REPORT.md` - –û retry –º–µ—Ö–∞–Ω–∏–∑–º–µ
- `ERROR_MESSAGE_IMPROVEMENTS.md` - –û —É–ª—É—á—à–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –≤–µ–±–µ
- `TELEGRAM_RATE_LIMIT_MESSAGE_FIXED.md` - –û —É–ª—É—á—à–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –±–æ—Ç–µ
- `SESSION_FIXES_SUMMARY.md` - –≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç

---

## –ü—Ä–æ—à–ª—ã–µ —Å—Ç–∞—Ç—É—Å—ã

‚úÖ –í—Å–µ –æ—à–∏–±–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã
‚úÖ –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç
‚úÖ Error messages –¥—Ä—É–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ
‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

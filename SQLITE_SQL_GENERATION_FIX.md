# SQLite SQL Generation Fix

## Problem

When using admin mode with the query "Сколько сообщений было отправлено на этой неделе?" (How many messages were sent this week?), the system generated MySQL-specific SQL:

```sql
SELECT COUNT(*) AS message_count
FROM messages
WHERE YEARWEEK(created_at, 1) = YEARWEEK(CURDATE(), 1);
```

**Error:**
```
The query failed because CURDATE() and YEARWEEK() are MySQL‑specific functions
– SQLite does not provide them.
```

## Root Cause

The LLM (Text-to-SQL converter) was not explicitly told that the database is **SQLite**, so it defaulted to generating MySQL SQL.

## Solution

### 1. Enhanced System Prompt (`src/text2sql.py`)

Added explicit instructions to the LLM:
- ✅ "You are a SQL expert for **SQLite database**"
- ✅ "This is an SQLite database, NOT MySQL"
- ✅ Provided SQLite date function examples
- ✅ Listed specific SQLite functions to use
- ✅ Explicitly warned against MySQL functions

**New System Prompt Includes:**
```python
SQLite Date Functions Reference:
-- Current week (ISO week starting Monday):
--   WHERE strftime('%W', created_at) = strftime('%W', 'now')
--     AND strftime('%Y', created_at) = strftime('%Y', 'now')
-- Current month:
--   WHERE strftime('%Y-%m', created_at) = strftime('%Y-%m', 'now')
-- Last 7 days:
--   WHERE created_at >= datetime('now', '-7 days')
-- Today:
--   WHERE date(created_at) = date('now')
```

### 2. MySQL to SQLite Converter (`src/text2sql.py`)

Added `_convert_mysql_to_sqlite()` function as a safety measure:
- Converts `CURDATE()` → `date('now')`
- Converts `NOW()` → `datetime('now')`
- Converts `YEARWEEK(...)` → SQLite equivalent with `strftime()`
- Converts `YEAR()`, `MONTH()`, `DAY()`, `WEEK()` → `strftime()` equivalents

This is a fallback mechanism in case the LLM still generates MySQL SQL despite instructions.

### 3. Automatic Conversion in Pipeline

The conversion is automatically applied after SQL extraction:
```python
# Convert MySQL functions to SQLite equivalents (safety measure)
sql = self._convert_mysql_to_sqlite(sql)
```

## SQLite vs MySQL Date Functions

| Operation | MySQL | SQLite |
|-----------|-------|--------|
| Current date | `CURDATE()` | `date('now')` |
| Current datetime | `NOW()` | `datetime('now')` |
| Current week number | `YEARWEEK()` | `strftime('%W', ...)` |
| Extract year | `YEAR()` | `strftime('%Y', ...)` |
| Extract month | `MONTH()` | `strftime('%m', ...)` |
| Extract day | `DAY()` | `strftime('%d', ...)` |
| Date comparison | `DATE()` | `date()` |

## Example Query Conversion

**Original (MySQL) - Generated by LLM:**
```sql
SELECT COUNT(*) AS message_count
FROM messages
WHERE YEARWEEK(created_at, 1) = YEARWEEK(CURDATE(), 1);
```

**Converted (SQLite) - After processing:**
```sql
SELECT COUNT(*) AS message_count
FROM messages
WHERE (strftime('%W', created_at) || strftime('%Y', created_at)) =
      (strftime('%W', date('now')) || strftime('%Y', date('now')));
```

**Correct (SQLite) - What LLM should generate directly:**
```sql
SELECT COUNT(*) AS message_count
FROM messages
WHERE strftime('%W', created_at) = strftime('%W', 'now')
  AND strftime('%Y', created_at) = strftime('%Y', 'now');
```

## Testing

### Test Queries

1. **Simple Count:**
   ```
   "Сколько всего сообщений?"
   Expected: SELECT COUNT(*) FROM messages;
   ```

2. **This Week:**
   ```
   "Сколько сообщений было отправлено на этой неделе?"
   Expected: Uses strftime('%W', ...) for week comparison
   ```

3. **This Month:**
   ```
   "Сколько сообщений в этом месяце?"
   Expected: Uses strftime('%Y-%m', ...) for month comparison
   ```

4. **Last 7 Days:**
   ```
   "Сколько сообщений за последние 7 дней?"
   Expected: Uses datetime('now', '-7 days')
   ```

### Verification

After deployment, verify that:
- ✅ Queries no longer produce "CURDATE() is not a function" errors
- ✅ Date-based queries return correct results
- ✅ Week/month aggregations work properly
- ✅ Both MySQL and SQLite function names are handled

## Files Modified

- ✅ `src/text2sql.py`:
  - Added `SQLITE_DATE_EXAMPLES` constant
  - Enhanced system prompt in `convert()` method
  - Added `_convert_mysql_to_sqlite()` function
  - Integrated conversion in SQL processing pipeline

## Deployment

No configuration changes needed. The fix is automatic and backward-compatible:
- Improves LLM prompting (primary fix)
- Adds conversion safety net (fallback)
- No API changes
- No breaking changes

## Future Improvements

1. **Database-Aware Converter:**
   - Detect database type automatically
   - Generate database-specific SQL per dialect

2. **Query Validation:**
   - Test generated SQL before returning
   - Provide helpful error messages for SQL errors

3. **Caching:**
   - Cache successful conversions for common queries
   - Build library of validated queries

4. **Multi-Database Support:**
   - PostgreSQL date functions
   - SQL Server date functions
   - Oracle date functions

---

**Status:** ✅ Complete and ready for testing
**Created:** October 18, 2025 (Day 6)
**Database:** SQLite

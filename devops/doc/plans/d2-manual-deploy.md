# Sprint D2: Развертывание на сервер

## Обзор

Развернуть приложение на production сервере (89.223.67.136) вручную по детальной инструкции. Использовать готовые образы из GHCR, настроить окружение и запустить все сервисы.

## Исходные данные

**Сервер:**

- IP: 89.223.67.136
- Пользователь: systech
- Рабочая директория: /opt/systech/vvelyus
- Порты: 3001 (Frontend), 8001 (API)
- Docker и Docker Compose установлены

**Образы:**

- ghcr.io/vvelyus/systech-aidd-test/bot:latest
- ghcr.io/vvelyus/systech-aidd-test/api:latest
- ghcr.io/vvelyus/systech-aidd-test/frontend:latest

## Задачи

### 1. Создать production конфигурацию

**Файл: `.env.production`**

- Шаблон всех переменных окружения для production
- Описание каждой переменной
- Примеры значений (без реальных секретов)
- Секции: Telegram, OpenRouter, API, Database, Logging

**Файл: `docker-compose.prod.yml`**

- На базе `docker-compose.registry.yml`
- Изменить порты: 3001 для frontend, 8001 для API
- Настроить NEXT_PUBLIC_API_URL на http://89.223.67.136:8001
- Volumes для production (data, logs, prompts)
- Restart policies для всех сервисов

### 2. Создать инструкцию по развертыванию

**Файл: `docs/guides/MANUAL_DEPLOY.md`**

**Структура инструкции:**

**Подготовка (локально):**

1. Проверка доступа к серверу (SSH тест)
2. Подготовка .env файла с реальными ключами
3. Проверка наличия необходимых файлов

**Подключение к серверу:**

1. Команда SSH с использованием ключа
2. Проверка версий Docker и Docker Compose
3. Создание рабочей директории /opt/systech/vvelyus

**Копирование файлов:**

1. Копирование docker-compose.prod.yml на сервер (scp)
2. Копирование .env.production как .env (scp)
3. Копирование prompts/system_prompt.txt (scp)
4. Проверка наличия всех файлов на сервере

**Подготовка директорий:**

1. Создание директорий data, logs, prompts
2. Установка прав доступа
3. Проверка структуры директорий

**Загрузка образов:**

1. docker pull для каждого образа
2. Проверка загруженных образов (docker images)

**Запуск сервисов:**

1. docker-compose up -d
2. Проверка статуса (docker-compose ps)
3. Просмотр логов (docker-compose logs)

**Миграции базы данных:**

1. Запуск миграций через API контейнер
2. Проверка таблиц в БД
3. Проверка логов миграций

**Проверка работоспособности:**

1. Проверка логов каждого сервиса
2. API healthcheck (curl http://localhost:8001/health)
3. Frontend доступность (curl http://localhost:3001)
4. Проверка доступа извне (через публичный IP)
5. Тест работы бота (отправка сообщения)

**Troubleshooting:**

- Частые проблемы и их решения
- Команды для диагностики
- Где искать логи

### 3. Создать вспомогательные скрипты

**Файл: `devops/scripts/check-server.sh`**

- Проверка доступности сервера
- Проверка версий Docker
- Проверка открытых портов

**Файл: `devops/scripts/deploy.sh`**

- Копирование файлов на сервер
- Запуск сервисов
- Базовая проверка

### 4. Обновить документацию

**Обновить: `devops/doc/devops-roadmap.md`**

- Отметить Sprint D2 как In Progress
- Добавить ссылку на MANUAL_DEPLOY.md

**Создать: `devops/doc/SPRINT_D2_PROGRESS.md`**

- Прогресс выполнения спринта
- Результаты каждого этапа
- Скриншоты/логи проверок

### 5. Выполнить развертывание

**По инструкции MANUAL_DEPLOY.md:**

1. Подготовить файлы локально
2. Подключиться к серверу
3. Скопировать файлы
4. Запустить сервисы
5. Выполнить все проверки
6. Документировать результаты

### 6. Финальная проверка

**Проверки:**

- Все контейнеры запущены и работают
- API отвечает на http://89.223.67.136:8001
- Frontend доступен на http://89.223.67.136:3001
- Bot получает и отвечает на сообщения
- Логи не содержат критических ошибок
- База данных создана и работает

**Документировать:**

- Создать отчет SPRINT_D2_COMPLETION.md
- Сделать скриншоты работающих сервисов
- Записать возникшие проблемы и решения

## Ожидаемый результат

- Приложение работает на production сервере
- Детальная инструкция для повторного развертывания
- Готовность к автоматизации в Sprint D3
- Все сервисы доступны через интернет

## Файлы для создания/изменения

**Новые:**

- `.env.production` - шаблон переменных окружения
- `docker-compose.prod.yml` - production конфигурация
- `docs/guides/MANUAL_DEPLOY.md` - инструкция по развертыванию
- `devops/scripts/check-server.sh` - скрипт проверки сервера
- `devops/scripts/deploy.sh` - скрипт развертывания
- `devops/doc/SPRINT_D2_PROGRESS.md` - прогресс спринта
- `devops/doc/SPRINT_D2_COMPLETION.md` - итоговый отчет

**Обновить:**

- `devops/doc/devops-roadmap.md` - статус Sprint D2

## Чек-лист выполнения

- [ ] Создать .env.production с описанием всех переменных
- [ ] Создать docker-compose.prod.yml с портами 3001/8001 и production настройками
- [ ] Создать docs/guides/MANUAL_DEPLOY.md с пошаговой инструкцией
- [ ] Создать скрипты check-server.sh и deploy.sh в devops/scripts/
- [ ] Обновить devops/doc/devops-roadmap.md (статус D2 -> In Progress)
- [ ] Выполнить развертывание на сервер по инструкции
- [ ] Проверить работу всех сервисов и доступность через интернет
- [ ] Создать отчет SPRINT_D2_COMPLETION.md с результатами


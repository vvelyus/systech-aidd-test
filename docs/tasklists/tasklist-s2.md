# Tasklist Sprint S2: –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ
**–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:** 16 –æ–∫—Ç—è–±—Ä—è 2025
**–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:** 16 –æ–∫—Ç—è–±—Ä—è 2025
**–¶–µ–ª—å:** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –∏–∑ Telegram

---

## –¶–µ–ª–∏ —Å–ø—Ä–∏–Ω—Ç–∞

- [x] –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –¥–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- [x] –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É `users` –≤ –ë–î
- [x] –ò—Å–ø—Ä–∞–≤–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ Alembic
- [x] –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- [x] –ü–æ–∫—Ä—ã—Ç—å —Ç–µ—Å—Ç–∞–º–∏ –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

---

## –ü—Ä–∏–Ω—Ü–∏–ø—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

‚úÖ **KISS (Keep It Simple, Stupid)** - –Ω–∏–∫–∞–∫–æ–≥–æ –æ–≤–µ—Ä–∏–Ω–∂–∏–Ω–∏—Ä–∏–Ω–≥–∞
- –û–¥–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ –ø–æ–ª—è–º–∏
- –û–¥–∏–Ω –º–µ—Ç–æ–¥ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏
- Graceful error handling

---

## –î–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω

### ‚úÖ –≠—Ç–∞–ø 1: –ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram

**–ó–∞–¥–∞—á–∏:**
- [x] –ò–∑—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–ª—è –≤ `aiogram.types.User`
- [x] –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∏ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
- [x] –°–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –û–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –ø–æ–ª—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:
- `telegram_id` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ, PK) - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –≤ Telegram
- `username` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ) - –º–æ–∂–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `first_name` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ) - –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `last_name` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ) - —Ñ–∞–º–∏–ª–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `language_code` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ) - —è–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `created_at` (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ) - –¥–∞—Ç–∞ –ø–µ—Ä–≤–æ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è
- `updated_at` (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ) - –¥–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

---

### ‚úÖ –≠—Ç–∞–ø 2: –°–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ User

**–§–∞–π–ª:** `src/models.py`

**–ó–∞–¥–∞—á–∏:**
- [x] –î–æ–±–∞–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç `Optional` (–ø–æ–∑–∂–µ –∑–∞–º–µ–Ω–µ–Ω –Ω–∞ `str | None`)
- [x] –°–æ–∑–¥–∞—Ç—å –∫–ª–∞—Å—Å `User(Base)`
- [x] –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—è –º–æ–¥–µ–ª–∏ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Ç–∏–ø–∞–º–∏
- [x] –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ `__repr__()` –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- [x] –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ `to_dict()` –¥–ª—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏

**–ö–æ–¥:**
```python
class User(Base):
    """–ú–æ–¥–µ–ª—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π Telegram."""

    __tablename__ = "users"

    telegram_id: Mapped[int] = mapped_column(Integer, primary_key=True)
    username: Mapped[str | None] = mapped_column(String(32), nullable=True, index=True)
    first_name: Mapped[str | None] = mapped_column(String(255), nullable=True)
    last_name: Mapped[str | None] = mapped_column(String(255), nullable=True)
    language_code: Mapped[str | None] = mapped_column(String(10), nullable=True)
    created_at: Mapped[datetime] = mapped_column(
        nullable=False, server_default=func.current_timestamp()
    )
    updated_at: Mapped[datetime] = mapped_column(
        nullable=False,
        server_default=func.current_timestamp(),
        onupdate=func.current_timestamp(),
    )
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ú–æ–¥–µ–ª—å —Å–æ–∑–¥–∞–Ω–∞ —Å –ø–æ–ª–Ω–æ–π —Ç–∏–ø–∏–∑–∞—Ü–∏–µ–π –∏ –º–µ—Ç–æ–¥–∞–º–∏

---

### ‚úÖ –≠—Ç–∞–ø 3: –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ Alembic

**–ó–∞–¥–∞—á–∏:**
- [x] –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é: `uv run alembic revision --autogenerate -m "create users table"`
- [x] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –º–∏–≥—Ä–∞—Ü–∏—é
- [x] –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (—É–¥–∞–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞ –∏–∑ `messages`)
- [x] –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é: `uv run alembic upgrade head`

**–§–∞–π–ª:** `alembic/versions/0f7d5dc69d1f_create_users_table.py`

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- –£–¥–∞–ª–µ–Ω–∞ –æ—à–∏–±–æ—á–Ω–∞—è —Å—Ç—Ä–æ–∫–∞: `op.drop_index(op.f('idx_user_id_created_at'), table_name='messages')`
- –£–¥–∞–ª–µ–Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∞—è —Å—Ç—Ä–æ–∫–∞ –∏–∑ `downgrade()`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ, —Ç–∞–±–ª–∏—Ü–∞ `users` —Å–æ–∑–¥–∞–Ω–∞ –≤ –ë–î

---

### ‚úÖ –≠—Ç–∞–ø 4: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ç–æ–¥–∞ upsert_user –≤ DatabaseManager

**–§–∞–π–ª:** `src/database.py`

**–ó–∞–¥–∞—á–∏:**
- [x] –î–æ–±–∞–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç—ã: `select` –∏–∑ sqlalchemy
- [x] –î–æ–±–∞–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç –º–æ–¥–µ–ª–∏ `User`
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–µ—Ç–æ–¥ `upsert_user()`
  - [x] –ü–æ–∏—Å–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ `telegram_id`
  - [x] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
  - [x] –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
  - [x] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π

**–ö–æ–¥:**
```python
async def upsert_user(
    self,
    telegram_id: int,
    username: str | None = None,
    first_name: str | None = None,
    last_name: str | None = None,
    language_code: str | None = None,
) -> User:
    """–°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ (upsert)."""
    async with self.get_session() as session:
        stmt = select(User).where(User.telegram_id == telegram_id)
        result = await session.execute(stmt)
        user = result.scalar_one_or_none()

        if user:
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ
            user.username = username
            user.first_name = first_name
            user.last_name = last_name
            user.language_code = language_code
            self._logger.debug(f"Updated user: telegram_id={telegram_id}")
        else:
            # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ
            user = User(
                telegram_id=telegram_id,
                username=username,
                first_name=first_name,
                last_name=last_name,
                language_code=language_code,
            )
            session.add(user)
            self._logger.info(f"Created new user: telegram_id={telegram_id}")

        await session.commit()
        await session.refresh(user)
        return user
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

---

### ‚úÖ –≠—Ç–∞–ø 5: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ TelegramBot

**–§–∞–π–ª:** `src/bot.py`

**–ó–∞–¥–∞—á–∏:**
- [x] –î–æ–±–∞–≤–∏—Ç—å TYPE_CHECKING –∏–º–ø–æ—Ä—Ç –¥–ª—è `DatabaseManager`
- [x] –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä `db_manager` –≤ `__init__`
- [x] –°–æ—Ö—Ä–∞–Ω–∏—Ç—å `db_manager` –∫–∞–∫ –∞—Ç—Ä–∏–±—É—Ç –∫–ª–∞—Å—Å–∞
- [x] –°–æ–∑–¥–∞—Ç—å –º–µ—Ç–æ–¥ `_save_user_data()` —Å graceful error handling
- [x] –í—ã–∑—ã–≤–∞—Ç—å `_save_user_data()` –≤ `cmd_start()`
- [x] –í—ã–∑—ã–≤–∞—Ç—å `_save_user_data()` –≤ `handle_message()`

**–ú–µ—Ç–æ–¥ _save_user_data:**
```python
async def _save_user_data(self, message: Message) -> None:
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î."""
    if not message.from_user or not self.db_manager:
        return

    try:
        await self.db_manager.upsert_user(
            telegram_id=message.from_user.id,
            username=message.from_user.username,
            first_name=message.from_user.first_name,
            last_name=message.from_user.last_name,
            language_code=message.from_user.language_code,
        )
    except Exception as e:
        # –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É, –Ω–æ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
        self.logger.error(f"Failed to save user data: {e}", exc_info=True)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ø—Ä–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏

---

### ‚úÖ –≠—Ç–∞–ø 6: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ main.py

**–§–∞–π–ª:** `src/main.py`

**–ó–∞–¥–∞—á–∏:**
- [x] –ü–µ—Ä–µ–¥–∞—Ç—å `db_manager` –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ `TelegramBot`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
```python
bot = TelegramBot(
    token=config.telegram_token,
    logger=logger,
    system_prompt=system_prompt,
    llm_client=llm_client,
    bot_name=config.bot_name,
    db_manager=db_manager,  # –î–æ–±–∞–≤–ª–µ–Ω–æ
)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ë–æ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

---

### ‚úÖ –≠—Ç–∞–ø 7: –ù–∞–ø–∏—Å–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤

#### 7.1 –¢–µ—Å—Ç—ã –¥–ª—è –º–æ–¥–µ–ª–∏ User

**–§–∞–π–ª:** `tests/test_models.py`

**–ó–∞–¥–∞—á–∏:**
- [x] –î–æ–±–∞–≤–∏—Ç—å –∫–ª–∞—Å—Å `TestUser` (6 —Ç–µ—Å—Ç–æ–≤):
  - [x] `test_user_creation` - —Å–æ–∑–¥–∞–Ω–∏–µ —Å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º–∏ –ø–æ–ª—è–º–∏
  - [x] `test_user_with_all_fields` - —Å–æ–∑–¥–∞–Ω–∏–µ —Å–æ –≤—Å–µ–º–∏ –ø–æ–ª—è–º–∏
  - [x] `test_user_repr` - –ø—Ä–æ–≤–µ—Ä–∫–∞ __repr__
  - [x] `test_user_to_dict` - –ø—Ä–æ–≤–µ—Ä–∫–∞ to_dict

- [x] –î–æ–±–∞–≤–∏—Ç—å –∫–ª–∞—Å—Å `TestUserPersistence` (3 —Ç–µ—Å—Ç–∞):
  - [x] `test_save_and_retrieve_user` - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ
  - [x] `test_user_created_at_auto` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ timestamps
  - [x] `test_user_without_optional_fields` - —Ä–∞–±–æ—Ç–∞ —Å NULL –∑–Ω–∞—á–µ–Ω–∏—è–º–∏

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** +7 —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –º–æ–¥–µ–ª–∏ User

---

#### 7.2 –¢–µ—Å—Ç—ã –¥–ª—è DatabaseManager.upsert_user

**–§–∞–π–ª:** `tests/test_database.py`

**–ó–∞–¥–∞—á–∏:**
- [x] `test_upsert_user_create` - —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- [x] `test_upsert_user_update` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ
- [x] `test_upsert_user_with_none_values` - —Ä–∞–±–æ—Ç–∞ —Å None
- [x] `test_upsert_user_logging` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** +4 —Ç–µ—Å—Ç–∞ –¥–ª—è –º–µ—Ç–æ–¥–∞ upsert_user

---

#### 7.3 –¢–µ—Å—Ç—ã –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ –±–æ—Ç–∞

**–§–∞–π–ª:** `tests/test_bot.py`

**–ó–∞–¥–∞—á–∏:**
- [x] –°–æ–∑–¥–∞—Ç—å —Ñ–∏–∫—Å—Ç—É—Ä—É `bot_with_db_manager`
- [x] `test_save_user_data_success` - —É—Å–ø–µ—à–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
- [x] `test_save_user_data_no_user` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- [x] `test_save_user_data_no_db_manager` - —Ä–∞–±–æ—Ç–∞ –±–µ–∑ db_manager
- [x] `test_save_user_data_handles_exception` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- [x] `test_cmd_start_saves_user_data` - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ /start
- [x] `test_handle_message_saves_user_data` - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ —Å–æ–æ–±—â–µ–Ω–∏–∏

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** +5 —Ç–µ—Å—Ç–æ–≤ –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –±–æ—Ç–∞

---

#### 7.4 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∏–∫—Å—Ç—É—Ä—ã mock_message

**–§–∞–π–ª:** `tests/conftest.py`

**–ó–∞–¥–∞—á–∏:**
- [x] –î–æ–±–∞–≤–∏—Ç—å `first_name`, `last_name`, `language_code` –≤ mock

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
```python
message.from_user.first_name = "Test"
message.from_user.last_name = "User"
message.from_user.language_code = "en"
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –§–∏–∫—Å—Ç—É—Ä–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å–µ –ø–æ–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

---

### ‚úÖ –≠—Ç–∞–ø 8: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

**–ó–∞–¥–∞—á–∏:**
- [x] –û–±–Ω–æ–≤–∏—Ç—å `migrations/schema.sql`:
  - [x] –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø—Ä–æ Sprint S2
  - [x] –î–æ–±–∞–≤–∏—Ç—å SQL –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã `users`
  - [x] –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å –¥–ª—è `username`
  - [x] –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—á–∞–Ω–∏—è –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã `users`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞

---

### ‚úÖ –≠—Ç–∞–ø 9: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞

**–ó–∞–¥–∞—á–∏:**
- [x] –ó–∞–ø—É—Å—Ç–∏—Ç—å `mypy`: ‚úÖ Success: no issues found
- [x] –ó–∞–ø—É—Å—Ç–∏—Ç—å `ruff check --fix`: ‚úÖ Fixed 10 issues (Optional ‚Üí str | None)
- [x] –ó–∞–ø—É—Å—Ç–∏—Ç—å `ruff format`: ‚úÖ No changes needed
- [x] –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã: ‚úÖ 105 passed

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ö–æ–¥ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –≤—Å–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º –∫–∞—á–µ—Å—Ç–≤–∞

---

## üìä –ò—Ç–æ–≥–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏

### –ö–æ–¥
- **–ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã:** 1 (`alembic/versions/0f7d5dc69d1f_create_users_table.py`)
- **–ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:** 5
  - `src/models.py` (+75 —Å—Ç—Ä–æ–∫)
  - `src/database.py` (+51 —Å—Ç—Ä–æ–∫–∞)
  - `src/bot.py` (+27 —Å—Ç—Ä–æ–∫)
  - `src/main.py` (+1 —Å—Ç—Ä–æ–∫–∞)
  - `migrations/schema.sql` (+21 —Å—Ç—Ä–æ–∫–∞)

### –¢–µ—Å—Ç—ã
- **–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤:** 105 (–±—ã–ª–æ 89, **+16 –Ω–æ–≤—ã—Ö**)
- **Coverage:** 99% (–±—ã–ª–æ 100%, -1% –∏–∑-–∑–∞ –Ω–æ–≤—ã—Ö —Å—Ç—Ä–æ–∫)
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç

### –ö–∞—á–µ—Å—Ç–≤–æ
- **mypy:** ‚úÖ No issues
- **ruff:** ‚úÖ No errors
- **Type safety:** ‚úÖ –ü–æ–ª–Ω–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è

---

## üéØ –î–æ—Å—Ç–∏–≥–Ω—É—Ç—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
‚úÖ –¢–∞–±–ª–∏—Ü–∞ `users` —Å–æ–∑–¥–∞–Ω–∞ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏
‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –ø–∞—Ç—Ç–µ—Ä–Ω upsert (—Å–æ–∑–¥–∞–Ω–∏–µ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)
‚úÖ Graceful error handling - –æ—à–∏–±–∫–∏ –ë–î –Ω–µ –ª–æ–º–∞—é—Ç –±–æ—Ç–∞
‚úÖ Timestamps (created_at, updated_at) —Ä–∞–±–æ—Ç–∞—é—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
‚úÖ –°–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–Ω—Ü–∏–ø—É KISS - –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –ø—Ä–æ—Å—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ
‚úÖ –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–≤–µ—Ä–∏–Ω–∂–∏–Ω–∏—Ä–∏–Ω–≥–∞
‚úÖ –ß–∏—Å—Ç–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –±–µ–∑ breaking changes
‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å (db_manager –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π)

### –ö–∞—á–µ—Å—Ç–≤–æ
‚úÖ –ü–æ–ª–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏ –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –ø—Ä–æ—Ö–æ–¥—è—Ç
‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞
‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- **–¢–∞–±–ª–∏—Ü–∞:** `users`
- **–ò–Ω–¥–µ–∫—Å—ã:**
  - PRIMARY KEY –Ω–∞ `telegram_id`
  - INDEX –Ω–∞ `username`
- **–ú–∏–≥—Ä–∞—Ü–∏—è:** `0f7d5dc69d1f_create_users_table`

### API
- **DatabaseManager.upsert_user()** - —Å–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **TelegramBot._save_user_data()** - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- –í—ã–∑–æ–≤ –≤ `cmd_start()` - –ø—Ä–∏ –∫–æ–º–∞–Ω–¥–µ /start
- –í—ã–∑–æ–≤ –≤ `handle_message()` - –ø—Ä–∏ –ª—é–±–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
- Graceful degradation - —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ db_manager

---

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- **Roadmap:** `docs/roadmap.md` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ S2
- **Schema:** `migrations/schema.sql` - –æ–±–Ω–æ–≤–ª–µ–Ω–∞ —Å—Ö–µ–º–∞ –ë–î
- **–ú–∏–≥—Ä–∞—Ü–∏—è:** `alembic/versions/0f7d5dc69d1f_create_users_table.py`

---

## üéâ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–°–ø—Ä–∏–Ω—Ç S2 —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω –∑–∞ **1 –¥–µ–Ω—å**. –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –ø—Ä–æ—Å—Ç–æ–µ –∏ –Ω–∞–¥–µ–∂–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ Telegram. –°–ª–µ–¥—É—è –ø—Ä–∏–Ω—Ü–∏–ø—É KISS, –∏–∑–±–µ–∂–∞–ª–∏ –æ–≤–µ—Ä–∏–Ω–∂–∏–Ω–∏—Ä–∏–Ω–≥–∞ –∏ —Å–æ–∑–¥–∞–ª–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞–±–æ—Ç–∞—é—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ —Å –ø–æ–ª–Ω—ã–º –ø–æ–∫—Ä—ã—Ç–∏–µ–º —Ç–µ—Å—Ç–∞–º–∏.

**–°–ª–µ–¥—É—é—â–∏–π —Å–ø—Ä–∏–Ω—Ç:** TBD



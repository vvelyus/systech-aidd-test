# üìä –í–∏–∑—É–∞–ª—å–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –ø—Ä–æ–µ–∫—Ç—É

> –ü–æ–Ω–∏–º–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ —á–µ—Ä–µ–∑ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é —Å —Ä–∞–∑–Ω—ã—Ö —Ç–æ—á–µ–∫ –∑—Ä–µ–Ω–∏—è

---

## üéØ –û –≥–∞–π–¥–µ

–≠—Ç–æ—Ç –≥–∞–π–¥ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ–µ–∫—Ç —á–µ—Ä–µ–∑ **—Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ç–∏–ø—ã –¥–∏–∞–≥—Ä–∞–º–º**, –∫–∞–∂–¥–∞—è –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –∞—Å–ø–µ–∫—Ç —Å–∏—Å—Ç–µ–º—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω—É–∂–Ω—É—é –¥–∏–∞–≥—Ä–∞–º–º—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–æ–≥–æ, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–Ω—è—Ç—å.

---

## üìê –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–í—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#1-–≤—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
2. [–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏](#2-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã-–∏-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏)
3. [–ü–æ—Ç–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è](#3-–ø–æ—Ç–æ–∫-–æ–±—Ä–∞–±–æ—Ç–∫–∏-—Å–æ–æ–±—â–µ–Ω–∏—è)
4. [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–ª–∞—Å—Å–æ–≤](#4-—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-–∫–ª–∞—Å—Å–æ–≤)
5. [–ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –∑–∞–ø—Ä–æ—Å–∞](#5-–∂–∏–∑–Ω–µ–Ω–Ω—ã–π-—Ü–∏–∫–ª-–∑–∞–ø—Ä–æ—Å–∞)
6. [–°–æ—Å—Ç–æ—è–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞](#6-—Å–æ—Å—Ç–æ—è–Ω–∏—è-–∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)
7. [–ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö](#7-–º–æ–¥–µ–ª—å-–¥–∞–Ω–Ω—ã—Ö)
8. [–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ](#8-—Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ)
9. [–ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏](#9-–∏—Å—Ç–æ—Ä–∏—è-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
10. [–ü—Ä–æ—Ü–µ—Å—Å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (TDD)](#10-–ø—Ä–æ—Ü–µ—Å—Å-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏-tdd)

---

## 1. –í—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

**–ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:** –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏ –∏—Ö –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ

```mermaid
graph TB
    subgraph External[External Services]
        User[User<br/>Telegram User]
        TG[Telegram API]
        OR[OpenRouter API]
    end

    subgraph Application[Application Layer]
        Main[main.py<br/>Entry Point]
        Bot[TelegramBot<br/>Commands & Messages]
        LLM[LLMClient<br/>LLM Integration]
        Storage[ContextStorage<br/>Dialog History]
        Config[Config<br/>Configuration]
        Messages[BotMessages<br/>Text Constants]
    end

    subgraph Infrastructure[Infrastructure]
        Logger[Logger<br/>Logging]
        Prompts[system_prompt.txt<br/>Bot Role]
    end

    User -->|messages| TG
    TG -->|polling| Bot
    Bot -->|responses| TG
    TG -->|responses| User

    Main --> Config
    Main --> Logger
    Main --> Bot
    Main --> LLM
    Main --> Storage

    Bot -->|uses| Messages
    Bot -.->|optional requests| LLM

    LLM -->|read/write| Storage
    LLM -->|API calls| OR

    Config -->|loads| Prompts

    Logger -.->|logs| Bot
    Logger -.->|logs| LLM
    Logger -.->|logs| Storage

    style User fill:#e1f5ff,stroke:#01579b,stroke-width:3px,color:#000
    style Bot fill:#fff3e0,stroke:#e65100,stroke-width:3px,color:#000
    style LLM fill:#f3e5f5,stroke:#4a148c,stroke-width:3px,color:#000
    style Storage fill:#e8f5e9,stroke:#1b5e20,stroke-width:3px,color:#000
    style Config fill:#fff9c4,stroke:#f57f17,stroke-width:2px,color:#000
    style Messages fill:#fce4ec,stroke:#880e4f,stroke-width:2px,color:#000
    style Logger fill:#f1f8e9,stroke:#558b2f,stroke-width:2px,color:#000
    style Prompts fill:#ede7f6,stroke:#4527a0,stroke-width:2px,color:#000
    style OR fill:#ffebee,stroke:#c62828,stroke-width:3px,color:#000
    style TG fill:#e0f2f1,stroke:#00695c,stroke-width:3px,color:#000
    style Main fill:#ffccbc,stroke:#d84315,stroke-width:3px,color:#000
```

**–ö–ª—é—á–µ–≤—ã–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è:**
- üöÄ **main.py** - –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä, —Å–æ–∑–¥–∞–µ—Ç –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- ü§ñ **Bot** - –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –æ—Ç Telegram
- üß† **LLM** - –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω –æ—Ç Telegram (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ)
- üíæ **Storage** - pluggable (Protocol-based)

---

## 2. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

**–ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:** –ò–µ—Ä–∞—Ä—Ö–∏—è –º–æ–¥—É–ª–µ–π –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```mermaid
graph LR
    subgraph Core[Core]
        Main[main.py]
    end

    subgraph Domain[Business Logic]
        Bot[bot.py]
        LLM[llm_client.py]
    end

    subgraph Storage[Storage]
        CS[context_storage.py]
        CSP[ContextStorage Protocol]
        IMS[InMemoryContextStorage]
    end

    subgraph Config[Configuration]
        Conf[config.py]
        Env[.env]
        Prompt[system_prompt.txt]
    end

    subgraph Utils[Utils]
        Msg[messages.py]
        Log[logger.py]
    end

    subgraph External[External]
        Aiogram[aiogram 3.x]
        OpenAI[openai]
        Dotenv[python-dotenv]
    end

    Main --> Bot
    Main --> LLM
    Main --> Conf
    Main --> Log
    Main --> IMS

    Bot --> Msg
    Bot -.->|optional| LLM
    Bot --> Aiogram

    LLM --> CSP
    LLM --> OpenAI

    IMS -.->|implements| CSP

    Conf --> Dotenv
    Conf --> Env
    Conf --> Prompt

    style Main fill:#ffccbc,stroke:#d84315,stroke-width:4px,color:#000
    style Bot fill:#fff3e0,stroke:#e65100,stroke-width:3px,color:#000
    style LLM fill:#f3e5f5,stroke:#4a148c,stroke-width:3px,color:#000
    style CSP fill:#c8e6c9,stroke:#2e7d32,stroke-width:3px,color:#000
    style IMS fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px,color:#000
    style Conf fill:#fff9c4,stroke:#f57f17,stroke-width:2px,color:#000
    style Msg fill:#fce4ec,stroke:#880e4f,stroke-width:2px,color:#000
    style Log fill:#f1f8e9,stroke:#558b2f,stroke-width:2px,color:#000
```

**–ü—Ä–∏–Ω—Ü–∏–ø –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:**
- ‚¨áÔ∏è –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã **–≤–Ω–∏–∑** (–æ—Ç –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–π –∫ –¥–µ—Ç–∞–ª—è–º)
- üîÑ –ù–µ—Ç —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- üì¶ Storage –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Protocol (Dependency Inversion)

---

## 3. –ü–æ—Ç–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è

**–ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:** –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–µ–π—Å—Ç–≤–∏–π –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è

```mermaid
sequenceDiagram
    autonumber
    participant U as User
    participant T as Telegram
    participant B as Bot
    participant M as Messages
    participant L as LLM
    participant S as Storage
    participant O as OpenRouter

    rect rgb(225, 245, 255)
        Note over U,T: User sends message
        U->>T: Text message
        T->>B: polling: new message
    end

    rect rgb(255, 243, 224)
        Note over B: Bot validates and processes
        B->>B: handle_message()
        B->>B: Check length
        alt Empty message
            B->>M: empty_message()
            M-->>B: Error text
            B->>T: Error response
            T->>U: Error
        else Too long (>4000)
            B->>M: message_too_long()
            M-->>B: Error text
            B->>T: Error response
            T->>U: Error
        end
        B->>T: send_chat_action(TYPING)
    end

    rect rgb(243, 229, 245)
        Note over L,S: LLM processes with context
        B->>L: get_response_with_context(user_id, text)
        L->>S: add_message(user_id, "user", text)
        S->>S: Add to history
        S->>S: Trim to 20 messages
        L->>S: get_context(user_id)
        S-->>L: [last 20 messages]
    end

    rect rgb(255, 235, 238)
        Note over L,O: Request to OpenRouter API
        L->>L: Build messages array
        L->>O: chat.completions.create()
        O-->>L: LLM response
    end

    rect rgb(243, 229, 245)
        Note over L,S: Save response
        L->>S: add_message(user_id, "assistant", response)
        S->>S: Add to history
        L-->>B: LLM response
    end

    rect rgb(225, 245, 255)
        Note over B,U: Send response to user
        B->>T: Response
        T->>U: Bot response
    end
```

**–í—Ä–µ–º–µ–Ω–Ω–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å:** ~1-3 —Å–µ–∫—É–Ω–¥—ã –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç OpenRouter)

---

## 4. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–ª–∞—Å—Å–æ–≤

**–ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:** –ö–ª–∞—Å—Å—ã, –∏—Ö –∞—Ç—Ä–∏–±—É—Ç—ã –∏ –º–µ—Ç–æ–¥—ã

```mermaid
classDiagram
    class Config {
        +str telegram_token
        +str openrouter_api_key
        +str bot_name
        +str openrouter_model
        +str system_prompt_file
        +int max_context_messages
        +from_env() Config
        +load_system_prompt() str
    }

    class TelegramBot {
        -Bot bot
        -Dispatcher dp
        -Logger logger
        -str system_prompt
        -LLMClient llm_client
        +cmd_start(Message)
        +cmd_help(Message)
        +cmd_role(Message)
        +cmd_reset(Message)
        +cmd_status(Message)
        +handle_message(Message)
        +start()
    }

    class LLMClient {
        -AsyncOpenAI client
        -str model
        -str system_prompt
        -Logger logger
        -ContextStorage context_storage
        +get_response(str) str
        +get_response_with_context(int, str) str
        +reset_context(int)
    }

    class ContextStorage {
        <<Protocol>>
        +add_message(int, str, str)
        +get_context(int) List
        +reset_context(int)
    }

    class InMemoryContextStorage {
        -Dict _storage
        -int _max_messages
        -int _max_users
        -Logger _logger
        +add_message(int, str, str)
        +get_context(int) List
        +reset_context(int)
        +get_user_count() int
        +clear_all()
    }

    class BotMessages {
        <<Static>>
        +welcome(str, str) str$
        +help_text() str$
        +role(str) str$
        +status() str$
        +context_reset_success() str$
        +empty_message() str$
        +message_too_long() str$
        +processing_error() str$
    }

    TelegramBot --> LLMClient : uses
    TelegramBot --> BotMessages : uses
    LLMClient --> ContextStorage : depends on
    InMemoryContextStorage ..|> ContextStorage : implements
    Config ..> BotMessages : creates prompt

    style Config fill:#fff9c4,stroke:#f57f17,stroke-width:2px,color:#000
    style TelegramBot fill:#fff3e0,stroke:#e65100,stroke-width:3px,color:#000
    style LLMClient fill:#f3e5f5,stroke:#4a148c,stroke-width:3px,color:#000
    style ContextStorage fill:#c8e6c9,stroke:#2e7d32,stroke-width:3px,color:#000
    style InMemoryContextStorage fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px,color:#000
    style BotMessages fill:#fce4ec,stroke:#880e4f,stroke-width:2px,color:#000
```

**–ü–∞—Ç—Ç–µ—Ä–Ω—ã:**
- üî∑ **Protocol** - ContextStorage (Dependency Inversion)
- üî∂ **Static Methods** - BotMessages (stateless)
- üîπ **Decorator** - @log_command (AOP pattern)
- üî∏ **Factory Method** - Config.from_env()

---

## 5. –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –∑–∞–ø—Ä–æ—Å–∞

**–ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:** –°–æ—Å—Ç–æ—è–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ –æ—Ç –Ω–∞—á–∞–ª–∞ –¥–æ –∫–æ–Ω—Ü–∞

```mermaid
stateDiagram-v2
    [*] --> MessageReceived : Telegram polling

    MessageReceived --> Validating : handle_message()

    Validating --> ErrorEmpty : if len < 1
    Validating --> ErrorTooLong : if len > 4000
    Validating --> Processing : if valid

    ErrorEmpty --> SendError
    ErrorTooLong --> SendError
    SendError --> [*]

    Processing --> ShowTyping : valid message
    ShowTyping --> AddToContext : TYPING action

    AddToContext --> GetContext : add user message
    GetContext --> TrimContext : fetch history
    TrimContext --> BuildRequest : trim to 20 msgs

    BuildRequest --> CallAPI : system + context
    CallAPI --> APISuccess : response OK
    CallAPI --> APIError : API fail

    APIError --> LogError
    LogError --> SendError

    APISuccess --> SaveResponse : extract content
    SaveResponse --> SendResponse : add to context
    SendResponse --> [*] : answer to user

    note right of Validating
        Edge cases
        Empty or too long
    end note

    note right of TrimContext
        Max 20 messages
        per user
    end note

    note right of CallAPI
        OpenRouter API
    end note
```

**–¢–æ—á–∫–∏ –æ—Ç–∫–∞–∑–∞:**
- ‚ùå –í–∞–ª–∏–¥–∞—Ü–∏—è (–ø—É—Å—Ç–æ–µ/–¥–ª–∏–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)
- ‚ùå API –æ—à–∏–±–∫–∞ (—Å–µ—Ç—å, –ª–∏–º–∏—Ç—ã, –∫–ª—é—á)
- ‚úÖ –í—Å–µ –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è gracefully

---

## 6. –°–æ—Å—Ç–æ—è–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

**–ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:** –ö–∞–∫ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞

```mermaid
stateDiagram-v2
    [*] --> NoContext : New user

    NoContext --> HasContext : add_message()

    state HasContext {
        [*] --> Growing
        Growing --> Growing : add_message()<br/>(< 20 msgs)
        Growing --> Full : add_message()<br/>(= 20 msgs)
        Full --> Full : add_message()<br/>(trim oldest)
    }

    HasContext --> NoContext : reset_context()
    HasContext --> NoContext : Evicted (LRU) when > 1000 users

    note right of NoContext
        User not in storage
        or context cleared
    end note

    note left of Growing
        Less than 20 messages
        Add to the end
    end note

    note left of Full
        Exactly 20 messages
        Remove oldest, add new
    end note
```

**–°—Ç—Ä–∞—Ç–µ–≥–∏–∏:**
- üîÑ **FIFO** –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø—Ä–∏ > 20 —Å–æ–æ–±—â–µ–Ω–∏–π)
- üîÑ **LRU** –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–ø—Ä–∏ > 1000 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)

---

## 7. –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö

**–ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:** –°—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö –∏ –∏—Ö —Å–≤—è–∑–∏

```mermaid
erDiagram
    CONFIG ||--|| TELEGRAM_TOKEN : contains
    CONFIG ||--|| OPENROUTER_KEY : contains
    CONFIG ||--o{ DEFAULTS : has
    CONFIG ||--|| PROMPT_FILE : references

    TELEGRAM_BOT ||--|| CONFIG : uses
    TELEGRAM_BOT ||--o| LLM_CLIENT : uses
    TELEGRAM_BOT }o--|| LOGGER : uses

    LLM_CLIENT ||--|| CONTEXT_STORAGE : uses
    LLM_CLIENT ||--|| OPENROUTER : calls
    LLM_CLIENT }o--|| LOGGER : uses

    CONTEXT_STORAGE ||--|{ USER_CONTEXT : stores
    USER_CONTEXT ||--|{ MESSAGE : contains

    MESSAGE {
        string role
        string content
    }

    USER_CONTEXT {
        int user_id PK
        list messages
    }

    CONTEXT_STORAGE {
        dict storage
        int max_messages
        int max_users
    }

    CONFIG {
        string telegram_token
        string openrouter_api_key
        string bot_name
        string openrouter_model
        string system_prompt_file
        int max_context_messages
    }
```

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
- üìä **20 —Å–æ–æ–±—â–µ–Ω–∏–π** –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- üë• **1000 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π** –º–∞–∫—Å–∏–º—É–º
- üìù **4000 —Å–∏–º–≤–æ–ª–æ–≤** –º–∞–∫—Å–∏–º—É–º –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏

---

## 8. –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

**–ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:** –¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è

```mermaid
graph TB
    subgraph Machine[Local Machine]
        subgraph Python[Python 3.11+ Environment]
            subgraph Process[Python Process]
                App[systech-aidd-test<br/>Single Instance]

                subgraph Memory[RAM]
                    Context[Context Storage<br/>max 1000 users<br/>max 20 msgs/user]
                end
            end

            Files[File System]
        end
    end

    subgraph External[External Services]
        Telegram[Telegram API<br/>api.telegram.org]
        OpenRouter[OpenRouter API<br/>openrouter.ai]
    end

    App -->|Polling<br/>getUpdates| Telegram
    Telegram -->|Messages| App

    App -->|HTTP POST<br/>chat.completions| OpenRouter
    OpenRouter -->|JSON Response| App

    App -->|Read| Files
    Files -.->|.env config| App
    Files -.->|system_prompt.txt| App
    App -->|Write| Files
    Files -.->|logs/bot.log| App

    Context -.->|stored in| Memory

    style App fill:#ffccbc,stroke:#d84315,stroke-width:3px,color:#000
    style Context fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px,color:#000
    style Files fill:#fff9c4,stroke:#f57f17,stroke-width:2px,color:#000
    style Telegram fill:#e1f5ff,stroke:#01579b,stroke-width:3px,color:#000
    style OpenRouter fill:#ffebee,stroke:#c62828,stroke-width:3px,color:#000
    style Memory fill:#f3e5f5,stroke:#4a148c,stroke-width:2px,color:#000
```

**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
- üñ•Ô∏è Single instance (–Ω–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–∞—è)
- üíæ In-memory storage (–Ω–µ –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–∞—è)
- üîÑ Polling mode (–Ω–µ webhook)
- üì¶ –ù–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏–∏ (–∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ make run)

**–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é:**
- ‚úÖ Protocol-based storage ‚Üí –ª–µ–≥–∫–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ Redis
- ‚úÖ Stateless design ‚Üí –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å N –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤
- ‚ö†Ô∏è Polling ‚Üí –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞ webhook

---

## 9. –ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

**–ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:** –≠–≤–æ–ª—é—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –ø–æ –∏—Ç–µ—Ä–∞—Ü–∏—è–º

```mermaid
gantt
    title Development History
    dateFormat YYYY-MM-DD
    section MVP Iterations
    Iteration 1 Setup and Bot      :done, i1, 2025-10-10, 1d
    Iteration 2 LLM Integration       :done, i2, 2025-10-10, 1d
    Iteration 3 Dialog Context      :done, i3, 2025-10-10, 1d
    Iteration 4 Tests and Finalize  :done, i4, 2025-10-10, 1d
    Iteration 5 AI Product with Role   :done, i5, 2025-10-11, 1d

    section Tech Debt
    TD-1 Quality Infrastructure     :done, td1, 2025-10-11, 1d
    TD-2 Config Refactoring          :done, td2, 2025-10-11, 1d
    TD-3 Coverage Extension         :done, td3, 2025-10-11, 1d
    TD-4 Bot SRP Refactoring         :done, td4, 2025-10-11, 1d
    TD-5 Storage Abstraction          :done, td5, 2025-10-11, 1d

    section Documentation
    Guides Must Have Guides           :active, doc1, 2025-10-16, 1d
```

**–ö–ª—é—á–µ–≤—ã–µ –≤–µ—Ö–∏:**
- üìÖ **–î–µ–Ω—å 1 (10.10):** MVP —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª (–∏—Ç–µ—Ä–∞—Ü–∏–∏ 1-4)
- üìÖ **–î–µ–Ω—å 2 (11.10):** AI-–ø—Ä–æ–¥—É–∫—Ç + —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ—Ö.–¥–æ–ª–≥–∞ (TD-1 ‚Üí TD-5)
- üìÖ **–î–µ–Ω—å 7 (16.10):** –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ –≥–∞–π–¥—ã

**–ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:**
- –ò—Ç–µ—Ä–∞—Ü–∏—è 1 ‚Üí 4: **0% ‚Üí 72%** test coverage
- TD-3: **72% ‚Üí 100%** test coverage
- TD-1 ‚Üí TD-5: **0 ‚Üí 49** —Ç–µ—Å—Ç–æ–≤

---

## 10. –ü—Ä–æ—Ü–µ—Å—Å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (TDD)

**–ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:** Workflow TDD —Ü–∏–∫–ª–∞

```mermaid
graph TD
    Start([Start Task]) --> ReadTask[Read<br/>Task]
    ReadTask --> ThinkSolution[Think<br/>Solution]

    ThinkSolution --> RED[RED Phase]

    subgraph TDD_Cycle[TDD Cycle]
        RED[Write<br/>failing test] --> RunTestRed[make test]
        RunTestRed --> CheckRed{Test<br/>fails?}
        CheckRed -->|No| RED
        CheckRed -->|Yes| GREEN[GREEN Phase]

        GREEN[Minimal<br/>implementation] --> RunTestGreen[make test]
        RunTestGreen --> CheckGreen{Test<br/>passes?}
        CheckGreen -->|No| GREEN
        CheckGreen -->|Yes| REFACTOR[REFACTOR Phase]

        REFACTOR{Need<br/>refactoring?} -->|Yes| ImproveCode[Improve<br/>code]
        ImproveCode --> RunCI[make ci]
        RunCI --> CheckCI{CI<br/>passes?}
        CheckCI -->|No| ImproveCode
        CheckCI -->|Yes| NextTest{More<br/>tests?}

        REFACTOR -->|No| NextTest
        NextTest -->|Yes| RED
    end

    NextTest -->|No| FinalCI[Final check<br/>make ci]
    FinalCI --> Commit[Git commit<br/>with message]
    Commit --> Done([Done])

    style Start fill:#e8f5e9,stroke:#2e7d32,stroke-width:3px,color:#000
    style RED fill:#ffebee,stroke:#c62828,stroke-width:3px,color:#000
    style GREEN fill:#e8f5e9,stroke:#2e7d32,stroke-width:3px,color:#000
    style REFACTOR fill:#fff3e0,stroke:#e65100,stroke-width:3px,color:#000
    style FinalCI fill:#e1f5fe,stroke:#01579b,stroke-width:2px,color:#000
    style Commit fill:#f3e5f5,stroke:#4a148c,stroke-width:2px,color:#000
    style Done fill:#c8e6c9,stroke:#1b5e20,stroke-width:3px,color:#000
    style TDD_Cycle fill:#f9fbe7,stroke:#827717,stroke-width:2px
```

**–ü—Ä–∞–≤–∏–ª–∞ TDD:**
1. üî¥ **RED:** –¢–µ—Å—Ç –î–û–õ–ñ–ï–ù —É–ø–∞—Å—Ç—å (–ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å —Ç–µ—Å—Ç–∞)
2. üü¢ **GREEN:** –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∫–æ–¥ –¥–ª—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è (–Ω–µ –±–æ–ª—å—à–µ!)
3. ‚ôªÔ∏è **REFACTOR:** –£–ª—É—á—à–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ (KISS!)

---

## üé® –õ–µ–≥–µ–Ω–¥–∞ —Ü–≤–µ—Ç–æ–≤

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- üü† **–û—Ä–∞–Ω–∂–µ–≤—ã–π** - –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ (main.py, Bot)
- üü£ **–§–∏–æ–ª–µ—Ç–æ–≤—ã–π** - –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ (LLM)
- üü¢ **–ó–µ–ª–µ–Ω—ã–π** - –•—Ä–∞–Ω–∏–ª–∏—â–µ (Storage)
- üü° **–ñ–µ–ª—Ç—ã–π** - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- üî¥ **–ö—Ä–∞—Å–Ω—ã–π** - –í–Ω–µ—à–Ω–∏–µ API
- üîµ **–°–∏–Ω–∏–π** - Telegram

### –°–æ—Å—Ç–æ—è–Ω–∏—è
- üü¢ **–ó–µ–ª–µ–Ω—ã–π** - –£—Å–ø–µ—Ö, –≤–∞–ª–∏–¥–Ω—ã–π
- üî¥ **–ö—Ä–∞—Å–Ω—ã–π** - –û—à–∏–±–∫–∞, –ø—Ä–æ–≤–∞–ª
- üü° **–ñ–µ–ª—Ç—ã–π** - –í –ø—Ä–æ—Ü–µ—Å—Å–µ
- üü£ **–§–∏–æ–ª–µ—Ç–æ–≤—ã–π** - –ü—Ä–æ–≤–µ—Ä–∫–∞

---

## üìö –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –¥–∏–∞–≥—Ä–∞–º–º–∞–º

### –•–æ—á—É –ø–æ–Ω—è—Ç—å –æ–±—â—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É
‚Üí [1. –í—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#1-–≤—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)

### –•–æ—á—É –ø–æ–Ω—è—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –º–æ–¥—É–ª–µ–π
‚Üí [2. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏](#2-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã-–∏-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏)

### –•–æ—á—É –ø–æ–Ω—è—Ç—å –∫–∞–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ
‚Üí [3. –ü–æ—Ç–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è](#3-–ø–æ—Ç–æ–∫-–æ–±—Ä–∞–±–æ—Ç–∫–∏-—Å–æ–æ–±—â–µ–Ω–∏—è)

### –•–æ—á—É –ø–æ–Ω—è—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–ª–∞—Å—Å–æ–≤
‚Üí [4. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–ª–∞—Å—Å–æ–≤](#4-—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-–∫–ª–∞—Å—Å–æ–≤)

### –•–æ—á—É –ø–æ–Ω—è—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞
‚Üí [5. –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –∑–∞–ø—Ä–æ—Å–∞](#5-–∂–∏–∑–Ω–µ–Ω–Ω—ã–π-—Ü–∏–∫–ª-–∑–∞–ø—Ä–æ—Å–∞)

### –•–æ—á—É –ø–æ–Ω—è—Ç—å —Ä–∞–±–æ—Ç—É –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
‚Üí [6. –°–æ—Å—Ç–æ—è–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞](#6-—Å–æ—Å—Ç–æ—è–Ω–∏—è-–∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)

### –•–æ—á—É –ø–æ–Ω—è—Ç—å –º–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö
‚Üí [7. –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö](#7-–º–æ–¥–µ–ª—å-–¥–∞–Ω–Ω—ã—Ö)

### –•–æ—á—É –ø–æ–Ω—è—Ç—å —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
‚Üí [8. –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ](#8-—Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ)

### –•–æ—á—É –ø–æ–Ω—è—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
‚Üí [9. –ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏](#9-–∏—Å—Ç–æ—Ä–∏—è-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)

### –•–æ—á—É –ø–æ–Ω—è—Ç—å –ø—Ä–æ—Ü–µ—Å—Å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
‚Üí [10. –ü—Ä–æ—Ü–µ—Å—Å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (TDD)](#10-–ø—Ä–æ—Ü–µ—Å—Å-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏-tdd)

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ –≥–∞–π–¥—ã

- **[ARCHITECTURE.md](ARCHITECTURE.md)** - –¢–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
- **[CODEBASE_TOUR.md](CODEBASE_TOUR.md)** - –¢—É—Ä –ø–æ –∫–æ–¥—É —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏
- **[DEVELOPMENT.md](DEVELOPMENT.md)** - –ü—Ä–æ—Ü–µ—Å—Å—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- **[TESTING.md](TESTING.md)** - –°—Ç—Ä–∞—Ç–µ–≥–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

---

**–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã! üìä**
